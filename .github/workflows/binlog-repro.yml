name: Binlog Comparison - Repro for aspnetcore#64897

on:
  push:
    branches: [ main, master, '**' ]
  pull_request:
  workflow_dispatch:

jobs:
  binlog-comparison:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      # ============================================================
      # RUNNER BUILD: Works correctly, uses RestoreLockedMode=false
      # for better binlog comparison with Docker builds
      # ============================================================
      - name: '[Runner] Restore with binlog (no locked mode)'
        run: dotnet restore /p:ContinuousIntegrationBuild=true /p:RestoreLockedMode=false -bl:runner-restore.binlog

      - name: '[Runner] Build with binlog'
        run: dotnet build -c Release /p:ContinuousIntegrationBuild=true --no-restore -bl:runner-build.binlog

      - name: '[Runner] Publish with binlog'
        run: dotnet publish -c Release -o runner-publish /p:ContinuousIntegrationBuild=true --no-build -bl:runner-publish.binlog

      - name: '[Runner] List _framework assets'
        run: |
          echo "=== Runner publish _framework contents ===" 
          if [ -d "runner-publish/wwwroot/_framework" ]; then
            find runner-publish/wwwroot/_framework -type f | sort
          else
            echo "WARNING: _framework directory does not exist!"
          fi

      - name: '[Runner] List all wwwroot assets'
        run: |
          echo "=== Runner publish wwwroot contents ==="
          find runner-publish/wwwroot -type f | sort

      # ============================================================
      # DOCKER BUILD (with workaround): Uses proper .dockerignore
      # that excludes runner-publish, out, etc. - THIS WORKS
      # ============================================================
      - name: '[Docker+Workaround] Build image with binlog extraction'
        run: |
          echo "Building with FULL .dockerignore (includes workaround exclusions)"
          docker build . --file Dockerfile.binlogs --target binlog-export --output type=local,dest=./docker-binlogs-workaround

      - name: '[Docker+Workaround] Show wwwroot file listing'
        run: |
          echo "=== Docker (with workaround) wwwroot files ==="
          cat docker-binlogs-workaround/docker-wwwroot-files.txt

      # ============================================================
      # DOCKER BUILD (without workaround): Uses minimal .dockerignore
      # that does NOT exclude runner-publish - THIS DEMONSTRATES THE BUG
      # ============================================================
      - name: '[Docker-NoWorkaround] Build image with binlog extraction'
        run: |
          echo "Building with MINIMAL .dockerignore (no workaround - demonstrates the issue)"
          # Swap .dockerignore to minimal version
          mv .dockerignore .dockerignore.full
          mv .dockerignore.minimal .dockerignore
          # Build - this may fail or produce incorrect output
          docker build . --file Dockerfile.binlogs --target binlog-export --output type=local,dest=./docker-binlogs-no-workaround || echo "BUILD FAILED (expected - demonstrates aspnetcore#64897)"
          # Restore original .dockerignore
          mv .dockerignore .dockerignore.minimal
          mv .dockerignore.full .dockerignore

      - name: '[Docker-NoWorkaround] Show wwwroot file listing (if exists)'
        run: |
          echo "=== Docker (NO workaround) wwwroot files ==="
          if [ -f "docker-binlogs-no-workaround/docker-wwwroot-files.txt" ]; then
            cat docker-binlogs-no-workaround/docker-wwwroot-files.txt
          else
            echo "Build failed - no output generated (this demonstrates the issue)"
          fi

      # ============================================================
      # COMPARISON: Side by side
      # ============================================================
      - name: 'Compare wwwroot contents'
        run: |
          echo "========================================"
          echo "COMPARISON: Runner vs Docker (with workaround)"
          echo "========================================"
          echo ""
          echo "--- Runner wwwroot files ---"
          find runner-publish/wwwroot -type f | sort > /tmp/runner-wwwroot.txt
          cat /tmp/runner-wwwroot.txt
          echo ""
          echo "--- Docker (with workaround) wwwroot files ---"
          cat docker-binlogs-workaround/docker-wwwroot-files.txt
          echo ""
          echo "--- Differences ---"
          # Normalize paths for comparison
          sed 's|runner-publish/||' /tmp/runner-wwwroot.txt > /tmp/runner-normalized.txt
          sed 's|/app/publish/||' docker-binlogs-workaround/docker-wwwroot-files.txt > /tmp/docker-normalized.txt
          echo "Files present in runner build but MISSING in docker build:"
          comm -23 /tmp/runner-normalized.txt /tmp/docker-normalized.txt || true
          echo ""
          echo "Files present in docker build but not in runner build:"
          comm -13 /tmp/runner-normalized.txt /tmp/docker-normalized.txt || true

      - name: 'Summary'
        run: |
          echo "========================================"
          echo "SUMMARY: aspnetcore#64897 Reproduction"
          echo "========================================"
          echo ""
          echo "This workflow demonstrates the issue where Docker builds"
          echo "may fail or produce different results than runner builds."
          echo ""
          echo "WORKAROUND: Add the following to .dockerignore:"
          echo "  **/publish"
          echo "  **/runner-publish"
          echo "  **/*.binlog"
          echo "  **/out"
          echo "  .dotnet"
          echo "  .Microsoft.DotNet.ImageBuilder"
          echo ""
          echo "See: https://github.com/dotnet/sdk/issues/37291#issuecomment-1921786357"

      # ============================================================
      # UPLOAD ARTIFACTS
      # ============================================================
      - name: Upload runner binlogs
        uses: actions/upload-artifact@v4
        with:
          name: runner-binlogs
          path: |
            runner-restore.binlog
            runner-build.binlog
            runner-publish.binlog

      - name: Upload docker binlogs (with workaround)
        uses: actions/upload-artifact@v4
        with:
          name: docker-binlogs-workaround
          path: docker-binlogs-workaround/

      - name: Upload docker binlogs (no workaround)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: docker-binlogs-no-workaround
          path: docker-binlogs-no-workaround/

      - name: Upload runner publish output
        uses: actions/upload-artifact@v4
        with:
          name: runner-publish-wwwroot
          path: runner-publish/wwwroot/
